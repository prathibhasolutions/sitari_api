<!DOCTYPE html>
<html>
<head>
    <title>Chat with {{ customer.name }}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fb; margin: 0; padding: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #0002; padding: 2rem; }
        h2 { color: #1a2947; margin-bottom: 1.5rem; }
        .chat-box { background: #e9eef6; border-radius: 10px; padding: 1.2rem; height: 370px; overflow-y: auto; margin-bottom: 1.5rem; }
        .msg { margin-bottom: 1.2rem; display: flex; }
        .msg.sent { justify-content: flex-end; }
        .msg.received { justify-content: flex-start; }
        .bubble { padding: 0.85rem 1.3rem; border-radius: 18px; max-width: 65%; font-size: 1.08rem; position: relative; }
        .msg.sent .bubble { background: #2563eb; color: #fff; border-bottom-right-radius: 6px; box-shadow: 0 2px 8px #2563eb22; }
        .msg.received .bubble { background: #f1f5f9; color: #1a2947; border-bottom-left-radius: 6px; box-shadow: 0 2px 8px #0001; }
        .timestamp { font-size: 0.92rem; color: #5a5a5a; margin-top: 0.3rem; text-align: right; opacity: 0.85; }
        form { display: flex; gap: 1rem; }
        input[type=text] { flex: 1; padding: 0.8rem; border-radius: 7px; border: 1px solid #bfc7d1; font-size: 1.05rem; background: #f8fafc; }
        button { background: #2563eb; color: #fff; border: none; border-radius: 7px; padding: 0.8rem 1.7rem; font-size: 1.05rem; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #174a8c; }
        .back-link { display: inline-block; margin-bottom: 1.5rem; color: #2563eb; text-decoration: none; font-weight: 500; }
    </style>
</head>
<body>
    <div class="wa-container">
        <div class="wa-sidebar">
            <div class="wa-sidebar-header">WhatsApp</div>
            <div class="wa-sidebar-list">
                {% for contact in customers %}
                <a class="wa-contact" href="{% url 'dashboard-chat' contact.id %}" {% if contact.id == customer.id %}style="background:#2563eb;"{% endif %}>
                    <!-- Profile picture removed -->
                    <div class="wa-contact-info">
                        <div class="wa-contact-name">{{ contact.name }}</div>
                        <div class="wa-contact-phone">{{ contact.phone_number }}</div>
                    </div>
                </a>
                {% empty %}
                <div class="wa-contact-empty">No customers found.</div>
                {% endfor %}
            </div>
        </div>
        <div class="wa-main">
            <div class="wa-main-header">
                <div class="wa-title">Chat with {{ customer.name }}</div>
                <div style="color:#444; font-size:1.1rem; margin-top:0.5rem;">Phone: <b>{{ customer.phone_number }}</b></div>
            </div>
            <div class="wa-chat-box" id="wa-chat-box">
                <!-- Messages will be loaded here by JS -->
            </div>
            <form method="post" class="wa-form" enctype="multipart/form-data">{% csrf_token %}
                <button type="button" id="attach-btn" class="wa-tooltip-btn" style="background:#fff; color:#2563eb; border-radius:50%; width:40px; height:40px; font-size:28px; border:none; margin-right:8px; box-shadow:0 2px 8px #2563eb22; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;" title="Upload">
                    <span style="display:inline-block; width:28px; height:28px; text-align:center; line-height:28px;">+</span>
                    <span class="wa-tooltip-text">Upload</span>
                </button>
                <input type="file" id="file-input" name="media" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display:none;" />
                <div id="wa-preview" style="display:none;align-items:center;gap:12px;margin-bottom:8px;"></div>
                <input type="text" name="content" placeholder="Type a message..." />
                <button type="submit">Send</button>
            </form>
            <script>
            document.getElementById('attach-btn').onclick = function() {
                document.getElementById('file-input').click();
            };
            document.getElementById('file-input').onchange = function() {
                const preview = document.getElementById('wa-preview');
                preview.innerHTML = '';
                if (this.files.length > 0) {
                    const file = this.files[0];
                    let previewHtml = '';
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewHtml = `<div style='position:relative;display:inline-block;'>
                                <img src='${e.target.result}' style='max-width:120px;max-height:120px;border-radius:10px;border:2px solid #2563eb;display:block;' />
                                    <button type='button' id='wa-clear-preview' style='position:absolute;top:8px;right:8px;background:#fff;color:#2563eb;border:none;border-radius:50%;width:24px;height:24px;font-size:18px;cursor:pointer;box-shadow:0 2px 8px #2563eb22;display:flex;align-items:center;justify-content:center;padding:0;line-height:24px;text-align:center;'>×</button>
                            </div>`;
                            preview.style.display = 'flex';
                            preview.innerHTML = previewHtml;
                            document.querySelector('input[name="content"]').focus();
                            document.getElementById('wa-clear-preview').onclick = function() {
                                document.getElementById('file-input').value = '';
                                preview.style.display = 'none';
                                preview.innerHTML = '';
                            };
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewHtml = `<div style='position:relative;display:flex;align-items:center;gap:8px;'><span style='font-size:1.1rem;color:#2563eb;'>${file.name}</span><a href='#' style='color:#2563eb;text-decoration:underline;font-size:0.98rem;' onclick='return false;'>Preview not available</a><button type='button' id='wa-clear-preview' style='background:#fff;color:#2563eb;border:none;border-radius:50%;width:24px;height:24px;font-size:16px;cursor:pointer;'>×</button></div>`;
                        preview.style.display = 'flex';
                        preview.innerHTML = previewHtml;
                        document.querySelector('input[name="content"]').focus();
                        document.getElementById('wa-clear-preview').onclick = function() {
                            document.getElementById('file-input').value = '';
                            preview.style.display = 'none';
                            preview.innerHTML = '';
                        };
                    }
                } else {
                    preview.style.display = 'none';
                    preview.innerHTML = '';
                }
            };
            // Tooltip show/hide logic
            var attachBtn = document.getElementById('attach-btn');
            var tooltip = attachBtn.querySelector('.wa-tooltip-text');
            attachBtn.onmouseenter = function() {
                tooltip.style.opacity = '1';
            };
            attachBtn.onmouseleave = function() {
                tooltip.style.opacity = '0';
            };
            </script>
        </div>
    </div>
    <script>
    function fetchMessages() {
        fetch('{% url "dashboard-chat-messages" customer.id %}')
            .then(response => response.json())
            .then(data => {
                const box = document.getElementById('wa-chat-box');
                if (!data.messages.length) {
                    box.innerHTML = '<div class="wa-empty">No messages yet.</div>';
                    return;
                }
                box.innerHTML = data.messages.map(msg => {
                    let mediaHtml = '';
                            if (msg.media_url) {
                                if (msg.media_type && msg.media_type.startsWith('image/')) {
                                    mediaHtml = `<img src="${msg.media_url}" style="width:100%;height:auto;display:block;border-radius:12px;margin:0;padding:0;border:none;box-shadow:none;background:none;" />`;
                        } else {
                            mediaHtml = `<a href="${msg.media_url}" target="_blank" style="display:block;margin-bottom:6px;color:#2563eb;">Download</a>`;
                        }
                    }
                    // WhatsApp-style tick marks for sent messages
                    let statusHtml = '';
                    if (msg.direction === 'sent') {
                        // WhatsApp-style SVG tick icons
                        if (msg.status === 'Pending') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M5 9l3 3 5-5' stroke='#b1b1b1' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Sent') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M5 9l3 3 5-5' stroke='#888' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Delivered') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:24px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M3 9l3 3 5-5' stroke='#2563eb' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg><svg viewBox='0 0 18 18' width='18' height='18' style='margin-left:-10px;'><path d='M7 11l3 3 5-5' stroke='#2563eb' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Read') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:24px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M3 9l3 3 5-5' stroke='#25d366' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg><svg viewBox='0 0 18 18' width='18' height='18' style='margin-left:-10px;'><path d='M7 11l3 3 5-5' stroke='#25d366' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Failed') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><line x1='5' y1='5' x2='13' y2='13' stroke='#d32f2f' stroke-width='2'/><line x1='13' y1='5' x2='5' y2='13' stroke='#d32f2f' stroke-width='2'/></svg></span>`;
                        } else {
                            statusHtml = '';
                        }
                    }
                    return `
                    <div class="wa-msg ${msg.direction}">
                        <div class="wa-bubble">
                            ${mediaHtml}
                            <span>${msg.content}</span>
                            <div class="wa-timestamp">${msg.timestamp} ${statusHtml}</div>
                        </div>
                    </div>
                    `;
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
    }
    setInterval(fetchMessages, 2000);
    window.onload = fetchMessages;
    </script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #ece5dd; margin: 0; }
        .wa-container { display: flex; height: 100vh; }
        .wa-sidebar { width: 340px; background: #174a8c; color: #fff; display: flex; flex-direction: column; }
        .wa-sidebar-header { font-size: 1.5rem; font-weight: 600; padding: 1.2rem 1.5rem; border-bottom: 1px solid #2563eb; background: #2563eb; }
        .wa-sidebar-list { flex: 1; overflow-y: auto; }
        .wa-contact { display: flex; align-items: center; gap: 1rem; padding: 0.7rem 1.2rem; border-bottom: 1px solid #2563eb; color: #fff; text-decoration: none; transition: background 0.2s; }
        .wa-contact:hover, .wa-contact[style] { background: #2563eb !important; }
        .wa-profile-pic { width: 48px; height: 48px; border-radius: 50%; overflow: hidden; background: #fff; display: flex; align-items: center; justify-content: center; }
        .wa-profile-pic img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .wa-profile-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.7rem; color: #2563eb; background: #e0e7ff; border-radius: 50%; }
        .wa-contact-info { flex: 1; }
        .wa-contact-name { font-weight: 500; font-size: 1.1rem; }
        .wa-contact-phone { font-size: 0.98rem; color: #b1b1b1; }
        .wa-contact-empty { padding: 2rem; color: #b1b1b1; text-align: center; }
        .wa-main { flex: 1; background: #f7f8fa; display: flex; flex-direction: column; }
        .wa-main-header { padding: 1.5rem 2rem 1rem 2rem; border-bottom: 1px solid #e0e0e0; background: #fff; }
        .wa-title { font-size: 2rem; color: #2563eb; font-weight: 600; }
        .wa-chat-box { flex: 1; background: #ece5dd; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.2rem; }
        .wa-msg { display: flex; }
        .wa-msg.sent { justify-content: flex-end; }
        .wa-msg.received { justify-content: flex-start; }
        .wa-bubble { padding: 1rem 1.5rem; border-radius: 18px; max-width: 60%; font-size: 1.08rem; position: relative; }
        .wa-msg.sent .wa-bubble { background: #2563eb; color: #fff; border-bottom-right-radius: 6px; box-shadow: 0 2px 8px #2563eb22; }
        .wa-msg.received .wa-bubble { background: #fff; color: #1a2947; border-bottom-left-radius: 6px; box-shadow: 0 2px 8px #0001; }
        .wa-timestamp { font-size: 0.92rem; color: #5a5a5a; margin-top: 0.3rem; text-align: right; opacity: 0.85; }
        .wa-form { display: flex; gap: 1rem; padding: 1.5rem 2rem; background: #fff; border-top: 1px solid #e0e0e0; }
        .wa-form input[type=text] { flex: 1; padding: 0.8rem; border-radius: 7px; border: 1px solid #bfc7d1; font-size: 1.05rem; background: #f8fafc; }
        .wa-form button { background: #2563eb; color: #fff; border: none; border-radius: 7px; padding: 0.8rem 1.7rem; font-size: 1.05rem; cursor: pointer; transition: background 0.2s; }
        .wa-form button:hover { background: #174a8c; }
        .wa-empty { color: #888; text-align: center; margin-top: 2rem; }
        .wa-tooltip-btn { position: relative; }
        .wa-tooltip-text {
            position: absolute;
            left: 50%;
            top: -32px;
            transform: translateX(-50%);
            background: #2563eb;
            color: #fff;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.98rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }
    </style>
    <script>
    function fetchMessages() {
        fetch('{% url "dashboard-chat-messages" customer.id %}')
            .then(response => response.json())
            .then(data => {
                const box = document.getElementById('wa-chat-box');
                if (!data.messages.length) {
                    box.innerHTML = '<div class="wa-empty">No messages yet.</div>';
                    return;
                }
                box.innerHTML = data.messages.map(msg => {
                    let mediaHtml = '';
                    let isImage = false;
                    if (msg.media_url) {
                        if (msg.media_type && msg.media_type.startsWith('image/')) {
                            mediaHtml = `<img src="${msg.media_url}" style="width:100%;height:auto;display:block;border-radius:12px;margin:0;padding:0;border:none;box-shadow:none;background:none;" />`;
                            isImage = true;
                        } else {
                            mediaHtml = `<a href="${msg.media_url}" target="_blank" style="display:block;margin-bottom:6px;color:#2563eb;">Download</a>`;
                        }
                    }
                    // WhatsApp-style tick marks for sent messages
                    let statusHtml = '';
                    if (msg.direction === 'sent') {
                        // WhatsApp-style SVG tick icons
                        if (msg.status === 'Pending') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M5 9l3 3 5-5' stroke='#b1b1b1' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Sent') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M5 9l3 3 5-5' stroke='#888' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Delivered') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:24px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M3 9l3 3 5-5' stroke='#2563eb' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg><svg viewBox='0 0 18 18' width='18' height='18' style='margin-left:-10px;'><path d='M7 11l3 3 5-5' stroke='#2563eb' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Read') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:24px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><path d='M3 9l3 3 5-5' stroke='#25d366' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg><svg viewBox='0 0 18 18' width='18' height='18' style='margin-left:-10px;'><path d='M7 11l3 3 5-5' stroke='#25d366' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg></span>`;
                        } else if (msg.status === 'Failed') {
                            statusHtml = `<span style="vertical-align:middle;display:inline-block;width:18px;height:18px;"><svg viewBox='0 0 18 18' width='18' height='18'><line x1='5' y1='5' x2='13' y2='13' stroke='#d32f2f' stroke-width='2'/><line x1='13' y1='5' x2='5' y2='13' stroke='#d32f2f' stroke-width='2'/></svg></span>`;
                        } else {
                            statusHtml = '';
                        }
                    }
                    // If image and no text, remove bubble background
                        if (isImage && (!msg.content || msg.content.trim() === '')) {
                            return `
                            <div class="wa-msg ${msg.direction}">
                                <div style="padding:2px 2px 0 2px;border-radius:14px;max-width:340px;background:rgba(37,99,235,0.08);box-shadow:0 2px 8px #2563eb11;">
                                    ${mediaHtml}
                                    <div class="wa-timestamp" style="color:#5a5a5a;text-align:right;margin-top:4px;font-size:0.92rem;">${msg.timestamp} ${statusHtml}</div>
                                </div>
                            </div>
                            `;
                    } else {
                        return `
                        <div class="wa-msg ${msg.direction}">
                            <div class="wa-bubble">
                                ${mediaHtml}${msg.content}
                                <div class="wa-timestamp">${msg.timestamp} ${statusHtml}</div>
                            </div>
                        </div>
                        `;
                    }
                }).join('');
                box.scrollTop = box.scrollHeight;
            });
    }
    setInterval(fetchMessages, 2000);
    window.onload = fetchMessages;
    </script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #ece5dd; margin: 0; }
        .wa-container { display: flex; height: 100vh; }
        .wa-sidebar { width: 320px; background: #111b21; color: #fff; display: flex; flex-direction: column; }
        .wa-sidebar-header { font-size: 1.5rem; font-weight: 600; padding: 1.2rem 1.5rem; border-bottom: 1px solid #222; background: #202c33; }
        .wa-sidebar-list { flex: 1; overflow-y: auto; }
        .wa-contact { display: block; padding: 1rem 1.5rem; border-bottom: 1px solid #222; color: #fff; text-decoration: none; transition: background 0.2s; }
        .wa-contact:hover { background: #222d35; }
        .wa-contact-name { font-weight: 500; font-size: 1.1rem; }
        .wa-contact-phone { font-size: 0.98rem; color: #b1b1b1; }
        .wa-main { flex: 1; background: #f7f8fa; display: flex; flex-direction: column; }
        .wa-main-header { padding: 1.5rem 2rem 1rem 2rem; border-bottom: 1px solid #e0e0e0; background: #fff; }
        .wa-title { font-size: 2rem; color: #2563eb; font-weight: 600; }
        .wa-chat-box { flex: 1; background: #ece5dd; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.2rem; }
        .wa-msg { display: flex; }
        .wa-msg.sent { justify-content: flex-end; }
        .wa-msg.received { justify-content: flex-start; }
        .wa-bubble { padding: 1rem 1.5rem; border-radius: 18px; max-width: 60%; font-size: 1.08rem; position: relative; }
        .wa-msg.sent .wa-bubble { background: #2563eb; color: #fff; border-bottom-right-radius: 6px; box-shadow: 0 2px 8px #2563eb22; }
        .wa-msg.received .wa-bubble { background: #fff; color: #1a2947; border-bottom-left-radius: 6px; box-shadow: 0 2px 8px #0001; }
        .wa-timestamp { font-size: 0.92rem; color: #5a5a5a; margin-top: 0.3rem; text-align: right; opacity: 0.85; }
        .wa-form { display: flex; gap: 1rem; padding: 1.5rem 2rem; background: #fff; border-top: 1px solid #e0e0e0; }
        .wa-form input[type=text] { flex: 1; padding: 0.8rem; border-radius: 7px; border: 1px solid #bfc7d1; font-size: 1.05rem; background: #f8fafc; }
        .wa-form button { background: #2563eb; color: #fff; border: none; border-radius: 7px; padding: 0.8rem 1.7rem; font-size: 1.05rem; cursor: pointer; transition: background 0.2s; }
        .wa-form button:hover { background: #174a8c; }
        .wa-empty { color: #888; text-align: center; margin-top: 2rem; }
    </style>
</body>
</html>